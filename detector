#!/usr/bin/env sh

set -em

su - postgres -c "PGDATA='/var/lib/postgresql/data' postgres" &
timeout 1m sh -c "until nc -z 127.0.0.1 5432; do sleep 1; done"
# @todo set up database
echo "ðŸš€ PostgreSQL with TimescaleDB is ready"

if [ -n "${username}" ] && [ -n "${password}" ]; then
  echo "ðŸ”‘ Using authentication"
  touch /opt/openeew/mosquitto_passwords
  mosquitto_passwd -b /opt/openeew/mosquitto_passwords "${username}" "${password}"
  echo "password_file /opt/openeew/mosquitto_passwords" >> /opt/openeew/mosquitto.conf
else
  echo "âš  Not using authentication"
fi

mosquitto -c /opt/openeew/mosquitto.conf -d
timeout 1m sh -c "until nc -z 127.0.0.1 1883; do sleep 1; done"
echo "ðŸš€ Mosquitto is ready"
python3 /opt/openeew/detection.py --username "${username}" --password "${password}"
